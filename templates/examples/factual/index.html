<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
    <title>Popoto Search</title>
    <script src="../../js/analytics.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.6/mapbox.css' rel='stylesheet'/>
    <link rel="stylesheet" href="../../css/popoto.min.css">
    <link rel="stylesheet" href="css/demo.css">
    <link rel="alternate stylesheet" title="neo4j" href="css/popoto.neo4j.css" disabled>
    <style>
        #popoto-graph:fullscreen {
            width: 100%;
            height: 100%;
        }

        #popoto-graph:-webkit-full-screen {
            width: 100%;
            height: 100%;
        }

        #popoto-graph:-moz-full-screen {
            width: 100%;
            height: 100%;
        }

        #popoto-graph:-ms-fullscreen {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="ppt-body">

<!-- Header with select option for language and style -->
<header class="ppt-header">
    <span class="select-boxes">
        <label><span id="langlabel">Language:</span>
            <select id="language">
                <option value="en_US">English</option>
                <option value="fr_FR">Fran√ßais</option>
            </select>
        </label>
        <label>Style:
            <select id="style">
                <option value="default">Default</option>
                <option value="neo4j">Neo4j like</option>
            </select>
        </label>
    </span>
</header>

<!-- Message section -->
<section class="ppt-section-tips">
    <p id="credit">This example is built using a dataset sample provided by <a href="http://www.factual.com/">Factual</a> modeled as a graph and injected into a <a href="http://neo4j.com/">Neo4j</a> database hosted by <a href="http://www.graphenedb.com/">GrapheneDB</a>. The map interaction is implemented with <a href="https://www.mapbox.com/">Mapbox</a> and the UI generated by <a href="http://www.popotojs.com">Popoto.js</a>.</p>

    <p id="tips"><a href="https://vimeo.com/115401847">Tips</a> - Click on a node to expand and select a value. Use "plus" button on a node to retrieve the relations. Right click on a node to remove a selection. Please post issues and feedback on this <a href="http://groups.google.com/d/forum/popotojs-alpha">Google Group</a>.</p>
</section>

<section class="ppt-section-main">
    <div class="ppt-container-graph">
        <nav id="popoto-taxonomy" class="ppt-taxo-nav">
            <!-- Label/taxonomy filter will be generated here -->
        </nav>
        <div id="popoto-graph" class="ppt-div-graph">
            <!-- Graph will be generated here-->
        </div>
    </div>

    <!-- By default the query viewer is generated on the HTML element with ID "popoto-query"
     If needed this id can be changed with property "popoto.query.containerId" -->

    <div id="popoto-query" class="ppt-container-query">
        <!-- Query viewer is generated here -->
    </div>

    <!-- Cypher query viewer has been partially disabled for this alpha release and only display the query as text if enabled -->
    <!--<div id="popoto-cypher" class="ppt-container-cypher">-->
    <!--</div>-->

    <!-- Add a header with total number of results count -->
    <div class="ppt-section-header">
        <span id="results">RESULTS</span> <span id="rescount" class="ppt-count"></span>
        <span style="float: right; font-size: 16px; font-weight: normal;">
        <label><span id="reschooser">Displayed results:</span>
            <select id="res-display">
                <option value="5">5</option>
                <option value="10" selected="selected">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="500">500</option>
                <option value="1000">1000</option>
                <option value="2000">2000</option>
            </select>
        </label>
        </span>
    </div>

    <div class="res-container">
        <div id="popoto-results" class="ppt-container-results">
            <!-- Results are generated here -->
        </div>
        <div id="map" class="map pad2">
            <!-- map generated here -->
        </div>
    </div>

</section>

<!-- Required scripts -->
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.6/mapbox.js'></script>
<script src="../../js/jquery-2.1.0.min.js" charset="utf-8"></script>
<script src="../../js/d3.v3.min.js" charset="utf-8"></script>
<script src="../../js/popoto.min.js" charset="utf-8"></script>
<script src="js/svg-data.js" charset="utf-8"></script>
<script src="js/svg-us-region-data.js" charset="utf-8"></script>
<script>

    //----------------------------- MAPBOX initialization
    L.mapbox.accessToken = "pk.eyJ1IjoicG90YXRvdGFydSIsImEiOiJ6WGh6QncwIn0.2w_3dfu_OViFuOVb_60gKw";
    var map = L.mapbox.map('map', 'potatotaru.lic1j7lb');
    map.scrollWheelZoom.disable();
    var layer = L.mapbox.featureLayer().addTo(map);
    // ------------------------------------------

    popoto.rest.CYPHER_URL = "http://www.popotojs.com/proxy.php";

    var locale = "en_US";
    var labels;
    var localizer = {
        "getLocalizedLabel": function (id, label) {
            if (labels.hasOwnProperty(id) && labels[id].hasOwnProperty(label)) {
                return labels[id][label];
            } else {
                console.warn("no localized label defined for (" + label + ") in group (" + id + ")");
                console.error("\"" + label + "\": \"XX\",");
                return "XX-" + label + "-XX";
            }
        },
        "getSemanticLocalizedLabel": function (id, label) {
            if (labels.hasOwnProperty(id) && labels[id].hasOwnProperty("P_" + label)) {
                return labels[id]["P_" + label];
            } else {
                console.warn("no localized label defined for (" + "P_" + label + ") in group (" + id + ")");
                console.error("\"" + "P_" + label + "\": \"XX\",");
                return "XX-" + "P_" + label + "-XX";
            }
        }
    };

    d3.select("#language").on("change", function () {
        var selectedLocale = this.options[this.selectedIndex].value;
        // Load localized labels

        d3.json("locale/" + selectedLocale + ".json", function (error, localizedLabels) {
            labels = localizedLabels;

            popoto.queryviewer.QUERY_STARTER = labels.query_find;
            popoto.queryviewer.CHOOSE_LABEL = labels.query_choose;
            popoto.graph.TOOL_TAXONOMY = labels.tool_taxonomy;
            popoto.graph.TOOL_CENTER = labels.tool_center;
            popoto.graph.TOOL_FULL_SCREEN = labels.tool_full_screen;

            // Recreate taxonomies panel
            d3.select("#" + popoto.taxonomy.containerId).selectAll("ul").data([]).exit().remove();
            popoto.taxonomy.createTaxonomyPanel();

            d3.select("#credit").html(labels.credit);
            d3.select("#tips").html(labels.tips);
            d3.select("#results").text(labels.results);
            d3.select("#reschooser").text(labels.reschooser);
            d3.select("#langlabel").text(labels.langlabel);
            d3.select("#popoto-taxonomy-menu").attr("title", popoto.graph.TOOL_TAXONOMY);
            d3.select("#popoto-center-menu").attr("title", popoto.graph.TOOL_CENTER);
            d3.select("#popoto-fullscreen-menu").attr("title", popoto.graph.TOOL_FULL_SCREEN);

            popoto.result.hasChanged = true; // used to update localized attribute in results
            popoto.update();
        });
    });

    d3.select("#style").on("change", function () {
        var selectedStyle = this.options[this.selectedIndex].value;

        if (selectedStyle == "neo4j") {
            popoto.graph.node.ELLIPSE_RX = 40;
            popoto.graph.node.ELLIPSE_RY = 40;
            popoto.graph.node.TEXT_Y = 6;
            popoto.graph.LINK_DISTANCE = 100;
            popoto.graph.node.NODE_MAX_CHARS = 13;
            popoto.graph.node.BACK_CIRCLE_R = 48
        } else {
            popoto.graph.node.ELLIPSE_RX = 50;
            popoto.graph.node.ELLIPSE_RY = 25;
            popoto.graph.node.TEXT_Y = 8;
            popoto.graph.LINK_DISTANCE = 150;
            popoto.graph.node.NODE_MAX_CHARS = 11;
            popoto.graph.node.BACK_CIRCLE_R = 70;
        }

        selectStyle(selectedStyle);
        popoto.graph.centerRootNode();
    });


    function selectStyle(style) {
        $('link[title]').each(function (i, link) {
            link.disabled = (link.title != style);
        });
    }

    popoto.query.RESULTS_PAGE_SIZE = 10;
    d3.select("#res-display").on("change", function () {
        popoto.query.RESULTS_PAGE_SIZE = this.options[this.selectedIndex].value;
        popoto.result.hasChanged = true;
        popoto.update();
    });

    // logger level is set to INFO to see generated Cypher queries in console logs
    popoto.logger.LEVEL = popoto.logger.LogLevels.INFO;

    // Defines the list of label provider to customize the graph behavior:
    // Only two labels are used in Neo4j movie graph example: "Movie" and Person
    popoto.provider.nodeProviders = {
        "Social": {
            "autoExpandRelations": true,
            "children": ["Bars", "Food and Dining"],
            "returnAttributes": ["factual_id", "name", "website", "latitude", "longitude", "address", "locality", "postcode", "tel", "fax", "email", "hours_display"],
            "constraintAttribute": "factual_id",
            "getDisplayType": function (node) {
                return popoto.provider.NodeDisplayTypes.SVG;
            },
            "getSVGPaths": function (d) {
                if (d.type === popoto.graph.node.NodeTypes.ROOT && d.value === undefined) {
                    var paths = [];
                    var initialPaths;
                    if (svgData.hasOwnProperty(d.label)) {
                        initialPaths = svgData[d.label].paths;
                    } else {
                        initialPaths = svgData["Social"].paths;
                    }

                    initialPaths.forEach(function (p) {
                        paths.push({
                            "d": p.d,
                            "class": "svg-root"
                        });
                    });
                    return paths;
                } else {
                    if (svgData.hasOwnProperty(d.label)) {
                        return svgData[d.label].paths;
                    } else {
                        return svgData["Social"].paths;
                    }
                }
            },
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getIsTextDisplayed": function (node) {
                return false;
            },
            "displayResults": displayResults // this function has been extracted to reuse it for Landmarks
        },
        "Landmarks": {
            "returnAttributes": ["factual_id", "name", "website", "latitude", "longitude", "address", "locality", "postcode", "tel", "fax", "email", "hours_display"],
            "constraintAttribute": "factual_id",
            "getDisplayType": function (node) {
                return popoto.provider.NodeDisplayTypes.SVG;
            },
            "getSVGPaths": function (d) {
                if (svgData.hasOwnProperty(d.label)) {
                    return svgData[d.label].paths;
                } else {
                    return svgData["Social"].paths;
                }
            },
            // Change displayed text to display full region name instead of code.
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getIsTextDisplayed": function (node) {
                return false;
            },
            "displayResults": displayResults
        },
        "Food and Dining": {
            "parent": "Social",
            // All the children listed here will inherit from Social provider definition properties
            "children": ["Bagels and Donuts", "Bakeries", "Cafes", "Dessert", "Ice Cream Parlors", "Juice Bars and Smoothies", "Restaurants"]
        },
        "Bars": {
            "parent": "Social",
            "children": ["Hotel Lounges", "Sports Bars", "Wine Bars"]
        },
        "Restaurants": {
            "parent": "Food and Dining",
            "children": ["American", "Asian", "Barbecue", "Burgers", "Chinese", "Delis", "Diners", "Fast Food", "Food Trucks", "French", "Indian", "Italian", "Japanese", "Korean", "Mexican", "Middle Eastern", "Pizza", "Seafood", "Steakhouses", "Sushi", "Thai", "Vegan and Vegetarian"]
        },
        "Cafes": {
            "parent": "Food and Dining",
            "children": ["Coffee and Tea Houses"]
        },
        "Chain": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "valueOrderByAttribute": "name",
            "isValueOrderAscending": true,
            "getDisplayType": function (node) {
                return popoto.provider.NodeDisplayTypes.IMAGE;
            },
            "getIsTextDisplayed": function (node) {
                return false;
            },
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getImagePath": function (d) {
                if (d.type === popoto.graph.node.NodeTypes.VALUE) {
                    return "logos/" + d.attributes.name + ".png";
                } else {
                    if (d.value === undefined) {
                        if (d.count == 0) {
                            return "logos/" + d.label + "_disabled.png";
                        } else {
                            return "logos/" + d.label + ".png";
                        }
                    } else {
                        return "logos/" + d.value.attributes.name + ".png";
                    }
                }
            },
            "getImageWidth": function (node) {
                return 80;
            },
            "getImageHeight": function (node) {
                return 80;
            },
            "isSearchable": false
        },
        "Cuisine": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "isSearchable": false,
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return localizer.getLocalizedLabel("Cuisine", node.attributes.name);
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return localizer.getLocalizedLabel("Cuisine", node.value.attributes.name);
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return localizer.getSemanticLocalizedLabel("Cuisine", node.attributes.name);
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return localizer.getSemanticLocalizedLabel("Cuisine", node.value.attributes.name);
                    }
                }
            }
        },
        "Country": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "getDisplayType": function (node) {
                return popoto.provider.NodeDisplayTypes.SVG;
            },
            "getSVGPaths": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return USRegionsSVGPaths["US"];
                } else {
                    if (node.value) {
                        return USRegionsSVGPaths["US"];
                    } else {
                        return USRegionsSVGPaths["WORLD"];
                    }
                }
            },
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return localizer.getLocalizedLabel("Country", node.attributes.name);
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return localizer.getLocalizedLabel("Country", node.value.attributes.name);
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return localizer.getSemanticLocalizedLabel("Country", node.attributes.name);
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return localizer.getSemanticLocalizedLabel("Country", node.value.attributes.name);
                    }
                }
            },
            "getIsTextDisplayed": function (node) {
                return false;
            },
            "isSearchable": false
        },
        "Founded": {
            "returnAttributes": ["year"],
            "constraintAttribute": "year",
            "isSearchable": false,
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.year;
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.year;
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.year;
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.year;
                    }
                }
            }
        },
        "Price": {
            "returnAttributes": ["value"],
            "constraintAttribute": "value",
            "isSearchable": false,
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return localizer.getLocalizedLabel("Price", node.attributes.value);
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return localizer.getLocalizedLabel("Price", node.value.attributes.value);
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return localizer.getSemanticLocalizedLabel("Price", node.attributes.value);
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return localizer.getSemanticLocalizedLabel("Price", node.value.attributes.value);
                    }
                }
            }
        },
        "Option": {
            "children": ["DietOption", "AccessibilityOption", "MealOption", "AttireOption"],
            "getIsGroup": function (node) {
                return true;
            },
            "getTextValue": function (node) {
                return localizer.getLocalizedLabel("Labels", node.label);
            },
            "getSemanticValue": function (node) {
                return localizer.getSemanticLocalizedLabel("Labels", node.label);
            },
            "isSearchable": false
        },
        "Boolean": {
            "children": ["HasWifi", "HasParking", "IsSmoking", "IsCashOnly", "IsReservation",
                "IsHealthy", "IsVegetarian", "IsGlutenFree", "IsLowFat", "IsVegan", "IsOrganic",
                "HasValet", "HasGarage", "IsStreet", "HasLot", "IsValidated", "IsFree",
                "IsKidGoodFor", "HasKidMenu", "IsGroupGoodFor", "IsAccessibleWheelchair", "HasSeatingOutdoor", "IsOpen24",
                "ServeBreakfast", "ServeLunch", "ServeDinner", "CanDeliver", "CanTakeout", "CanCater",
                "ServeAlcohol", "IsBeerWineOnly", "HasBar", "IsBYOB"
            ],
            "returnAttributes": ["value"],
            "constraintAttribute": "value",
            "isSearchable": false,
            "getDisplayType": function (node) {
                return popoto.provider.NodeDisplayTypes.SVG;
            },
            "getIsTextDisplayed": function (node) {
                return false;
            },
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return localizer.getLocalizedLabel("Boolean", node.attributes.value);
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return localizer.getLocalizedLabel("Boolean", node.value.attributes.value);
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return localizer.getSemanticLocalizedLabel("Boolean", node.attributes.value);
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return localizer.getSemanticLocalizedLabel("Boolean", node.value.attributes.value);
                    }
                }
            },
            "getSVGPaths": function (d) {
                if (d.type === popoto.graph.node.NodeTypes.VALUE) {
                    if (d.attributes.value) {
                        return svgData["Boolean"].truePaths;
                    } else {
                        return svgData["Boolean"].falsePaths;
                    }
                } else {
                    if (d.value === undefined) {
                        var paths = [];

                        if (d.count == 0) {
                            svgData[d.label].paths.forEach(function (p) {
                                paths.push({
                                    "d": p.d,
                                    "class": "svg-disabled"
                                });
                            });
                        } else {
                            if (svgData.hasOwnProperty(d.label)) {
                                paths = svgData[d.label].paths;
                            } else {
                                paths = svgData["Boolean"].paths;
                            }
                        }
                        return paths;
                    } else {
                        if (d.value.attributes.value) {
                            return svgData["Boolean"].truePaths;
                        } else {
                            return svgData["Boolean"].falsePaths;
                        }
                    }
                }
            }
        },
        "Attire": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "isSearchable": false,
            "getDisplayType": function (node) {
                return popoto.provider.NodeDisplayTypes.IMAGE;
            },
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getIsTextDisplayed": function (node) {
                return false;
            },
            "getImagePath": function (d) {
                if (d.type === popoto.graph.node.NodeTypes.VALUE) {
                    return "attire/" + d.attributes.name + ".png";
                } else {
                    if (d.value === undefined) {
                        if (d.count == 0) {
                            return "attire/" + d.label + "_disabled.png";
                        } else {
                            return "attire/" + d.label + ".png";
                        }
                    } else {
                        return "attire/" + d.value.attributes.name + ".png";
                    }
                }
            },
            "getImageWidth": function (node) {
                return 80;
            },
            "getImageHeight": function (node) {
                return 80;
            }
        },
        "AttireProhibited": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "getDisplayType": function (node) {
                return popoto.provider.NodeDisplayTypes.SVG;
            },
            "getIsTextDisplayed": function (node) {
                return false;
            },
            "getSVGPaths": function (d) {
                if (d.type === popoto.graph.node.NodeTypes.VALUE) {
                    return svgData[d.attributes.name].paths
                } else {
                    if (d.value) {
                        return svgData[d.value.attributes.name].paths
                    } else {
                        if (d.count == 0) {
                            var paths = [];
                            svgData[d.label].paths.forEach(function (p) {
                                paths.push(
                                        {
                                            "d": p.d,
                                            "class": "svg-disabled"
                                        }
                                );
                            });
                            return paths;
                        } else {
                            return svgData[d.label].paths
                        }
                    }
                }
            },
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "isSearchable": false
        },
        "Region": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "getDisplayType": function (node) {
                return popoto.provider.NodeDisplayTypes.SVG;
            },
            "getSVGPaths": function (node) {
                // Create the list of SVG path to draw the node.
                // A path here is composed of two elements: the SVG path ("d" attribute) and a CSS class
                var paths = [];

                // In this example the paths are stored in "USRegionsSVGPaths" variable defined in svg-location-data.js referenced script.
                // But here you could consider using json, generated path, a dedicated service or even paths stored in node attribute data.

                // Add US background path:
                paths = paths.concat(USRegionsSVGPaths["US"]);

                // Then depending on node type add the path of the region.
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    // The node is an expanded value then the path corresponding to the region name is added:
                    paths = paths.concat(USRegionsSVGPaths["US-" + node.attributes.name]);
                } else {
                    if (node.value) {
                        // The node is an expandable node with a selected value then the path corresponding to the selected value region name is added:
                        paths = paths.concat(USRegionsSVGPaths["US-" + node.value.attributes.name]);
                    }
                }
                return paths;
            },
            // Change displayed text to display full region name instead of code.
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return localizer.getLocalizedLabel("Region", node.attributes.name);
                } else {
                    if (node.value === undefined) {
                        return node.label;
                    } else {
                        return localizer.getLocalizedLabel("Region", node.value.attributes.name);
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return localizer.getLocalizedLabel("Region", node.attributes.name);
                } else {
                    if (node.value === undefined) {
                        return node.label;
                    } else {
                        return localizer.getLocalizedLabel("Region", node.value.attributes.name);
                    }
                }
            },
            "getIsTextDisplayed": function (node) {
                return false;
            },
            "isSearchable": false
        },
        "Locality": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "isSearchable": false
        },
        "Neighborhood": {
            "returnAttributes": ["name"],
            "constraintAttribute": "name",
            "getTextValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "getSemanticValue": function (node) {
                if (node.type === popoto.graph.node.NodeTypes.VALUE) {
                    return node.attributes.name;
                } else {
                    if (node.value === undefined) {
                        return localizer.getSemanticLocalizedLabel("Labels", node.label);
                    } else {
                        return node.value.attributes.name;
                    }
                }
            },
            "isSearchable": false
        }
    };

    function displayResults(pElmt) {
        pElmt.on("mouseover", function (d) {
            if (d.mapLayer) {
                d.mapLayer.setIcon(L.icon({
                    iconUrl: 'icon/marker_s.png',
                    iconSize: [56, 56],
                    iconAnchor: [28, 28],
                    popupAnchor: [0, -34]
                }));
            }
        });

        pElmt.on("mouseout", function (d) {
            if (d.mapLayer) {
                d.mapLayer.setIcon(L.icon({
                    iconUrl: 'icon/marker.png',
                    iconSize: [56, 56],
                    iconAnchor: [28, 28],
                    popupAnchor: [0, -34]
                }));
            }
        });

        pElmt.on("click", function (d) {
            if (d.mapLayer) {
                map.setView(d.mapLayer._latlng, 16);
            }
        });

        var table = pElmt.append("table")
                .attr("class", "result-table");

        var tr = table.append("tr")
                .attr("id", "row1");
        var tr2 = table.append("tr")
                .attr("id", "row2");
        var tr3 = table.append("tr")
                .attr("id", "row3");
        var tr4 = table.append("tr")
                .attr("id", "row4");

        // Name
        tr.append("td")
                .append("h2")
                .append("a")
                .attr("href", function (d) {
                    if (d.attributes.website) {
                        return d.attributes.website;
                    } else {
                        return "#";
                    }
                })
                .text(function (d) {
                    return d.attributes.name;
                });

        tr2.append("td")
                .text(function (d) {
                    return d.attributes.address + " " + d.attributes.postcode + " " + d.attributes.locality;
                });

        tr3.append("td")
                .text(function (d) {
                    return localizer.getLocalizedLabel("Results", "phone") + ": " + d.attributes.tel;
                });

        tr4.append("td")
                .text(function (d) {
                    return ((d.attributes.email !== null && d.attributes.email != "") ? localizer.getLocalizedLabel("Results", "email") + ": " + d.attributes.email : "");
                });

    }


    // Define the label provider used to customize the link displayed text:
    popoto.provider.linkProvider = {

        // Customize the text displayed on links:
        "getLinkTextValue": function (link) {

            // The links labels are just changed in lower case in this example.
            // But it is possible to use a localization mechanism here to replace values.
            if (link.type === popoto.graph.link.LinkTypes.RELATION) {
                return localizer.getLocalizedLabel("Links", link.label);
            } else {
                return popoto.provider.DEFAULT_LINK_PROVIDER.getLinkTextValue(link);
            }
        },

        // Customize the text displayed on links:
        "getLinkSemanticValue": function (link) {

            if (link.type === popoto.graph.link.LinkTypes.RELATION) {
                return localizer.getLocalizedLabel("Links", "P_" + link.label);
            } else {
                return popoto.provider.DEFAULT_LINK_PROVIDER.getLinkTextValue(link);
            }
        }
    };

    // Define the label provider used to customize the taxonomies:
    popoto.provider.taxonomyProvider = {
        // Customize the text displayed on links:
        "getTextValue": function (label) {
            return localizer.getLocalizedLabel("Labels", label);
        }
    };

    // Add a listener on returned result count to update count in page
    popoto.result.onTotalResultCount(function (count) {
        d3.select("#rescount").text(function (d) {
            return "(" + count + ")";
        })
    });

    layer.on('mouseover', function (e) {
        e.layer.openPopup();
        e.layer.setIcon(L.icon({
            iconUrl: 'icon/marker_s.png',
            iconSize: [56, 56],
            iconAnchor: [28, 28],
            popupAnchor: [0, -34]
        }));
    });

    layer.on('mouseout', function (e) {
        e.layer.closePopup();
        e.layer.setIcon(L.icon({
            iconUrl: 'icon/marker.png',
            iconSize: [56, 56],
            iconAnchor: [28, 28],
            popupAnchor: [0, -34]
        }));
    });

    layer.on('layeradd', function (e) {
        var marker = e.layer;
        var prop = marker.feature.properties;

        var popup = '<h3>' + prop.name + '</h3><div>' + prop.address + " " + prop.postcode + " " + prop.locality + '</div><div>' + prop.tel + '</div>';

        marker.setIcon(L.icon({
            iconUrl: 'icon/marker.png',
            iconSize: [56, 56],
            iconAnchor: [28, 28],
            popupAnchor: [0, -34]
        }));

        marker.bindPopup(popup);
    });

    layer.on('click', function (e) {
        map.setView(e.latlng, 16);
    });

    /**
     * Add a listener on result received to update map.
     */
    popoto.result.onResultReceived(
            function (resultObjects) {
                var geojson = createGeojson(resultObjects);
                layer.setGeoJSON(geojson);

                if (layer.getBounds().isValid()) {
                    map.fitBounds(layer.getBounds().pad(0.1));
                }

                var index = 0;
                layer.eachLayer(function (aLayer) {
                    resultObjects[index].mapLayer = aLayer;
                    index++;
                });
            }
    );

    /**
     * Create a Geojson object usable by mapbox from the result list.
     *
     * @param resultObjects
     * @returns {{type: string, features: Array}}
     */
    function createGeojson(resultObjects) {
        var features = [];

        for (var i = 0; i < resultObjects.length; i++) {
            var longitude = Number(resultObjects[i].attributes.longitude);
            var latitude = Number(resultObjects[i].attributes.latitude);

            if (longitude && latitude) {
                features.push({
                    "resultObject": resultObjects[i],
                    "type": "Feature",
                    properties: {
                        "name": resultObjects[i].attributes.name,
                        "address": resultObjects[i].attributes.address,
                        "postcode": resultObjects[i].attributes.postcode,
                        "locality": resultObjects[i].attributes.locality,
                        "tel": resultObjects[i].attributes.tel
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            longitude,
                            latitude
                        ]
                    }
                })
            }
        }

        return {
            "type": "FeatureCollection",
            "features": features
        };
    }

    // Load localized labels
    d3.json("locale/" + locale + ".json", function (error, localizedLabels) {
        labels = localizedLabels;

        // Start the generation using parameter as root label of the query.
        popoto.start("Restaurants");
    });

</script>
</body>
</html>
